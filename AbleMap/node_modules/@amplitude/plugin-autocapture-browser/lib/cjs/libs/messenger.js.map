{"version":3,"file":"messenger.js","sourceRoot":"","sources":["../../../src/libs/messenger.ts"],"names":[],"mappings":"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","sourcesContent":["/* istanbul ignore file */\n/* eslint-disable no-restricted-globals */\nimport {\n  AMPLITUDE_ORIGIN,\n  AMPLITUDE_VISUAL_TAGGING_SELECTOR_SCRIPT_URL,\n  AMPLITUDE_VISUAL_TAGGING_HIGHLIGHT_CLASS,\n} from '../constants';\nimport { asyncLoadScript, generateUniqueId, getEventTagProps } from '../helpers';\nimport { ILogger, Messenger, ActionType } from '@amplitude/analytics-core';\n\nexport type Action =\n  | 'ping'\n  | 'pong'\n  | 'page-loaded'\n  | 'selector-loaded'\n  | 'initialize-visual-tagging-selector'\n  | 'close-visual-tagging-selector'\n  | 'element-selected'\n  | 'track-selector-mode-changed'\n  | 'track-selector-moved';\n\ninterface InitializeVisualTaggingSelectorData {\n  actionType: ActionType;\n}\n\ninterface ElementSelectedData {\n  '[Amplitude] Element Hierarchy'?: string;\n  '[Amplitude] Element Tag'?: string;\n  '[Amplitude] Element Text'?: string;\n  '[Amplitude] Page URL'?: string;\n  elementScreenshot?: Blob;\n}\n\ninterface TrackSelectorModeChangedData {\n  newMode: string;\n  pageUrl?: string;\n}\n\ninterface TrackSelectorMovedData {\n  newEditorLocation: string;\n  pageUrl?: string;\n}\n\nexport type ActionData = {\n  ping: null | undefined;\n  pong: null | undefined;\n  'page-loaded': null | undefined;\n  'selector-loaded': null | undefined;\n  'initialize-visual-tagging-selector': InitializeVisualTaggingSelectorData | null | undefined;\n  'close-visual-tagging-selector': null | undefined;\n  'element-selected': ElementSelectedData;\n  'track-selector-mode-changed': TrackSelectorModeChangedData;\n  'track-selector-moved': TrackSelectorMovedData;\n};\n\nexport interface Message<A extends Action> {\n  action: A;\n  data?: ActionData[A];\n}\n\ntype MessageRequest = {\n  id: string;\n  action: string;\n  args: Record<string, any>;\n};\n\ntype MessageResponse = {\n  id: string;\n  action: string;\n  responseData: any;\n};\n\n// TODO: use MessageChannel instead of window.postMessage\nexport class WindowMessenger implements Messenger {\n  endpoint = AMPLITUDE_ORIGIN;\n  logger?: ILogger;\n  requestCallbacks: {\n    [id: string]: {\n      resolve: (data: any) => void;\n      reject: (data: any) => void;\n    };\n  } = {};\n\n  constructor({ origin = AMPLITUDE_ORIGIN }: { origin?: string } = {}) {\n    this.endpoint = origin;\n  }\n\n  private notify(message: Message<Action> | MessageRequest) {\n    this.logger?.debug?.('Message sent: ', JSON.stringify(message));\n    (window.opener as WindowProxy)?.postMessage?.(message, this.endpoint);\n  }\n\n  // Send an async request to the parent window\n  public sendRequest(action: string, args: Record<string, any>, options = { timeout: 15_000 }): Promise<any> {\n    // Create Request ID\n    const id = generateUniqueId();\n    const request = {\n      id,\n      action,\n      args,\n    };\n\n    // Create a Promise that will be resolved when the response is received\n    const promise = new Promise((resolve, reject) => {\n      this.requestCallbacks[id] = { resolve, reject };\n\n      // Send the request\n      this.notify(request);\n\n      // Handle request timeouts\n      if (options?.timeout > 0) {\n        setTimeout(() => {\n          reject(new Error(`${action} timed out (id: ${id})`));\n          delete this.requestCallbacks[id];\n        }, options.timeout);\n      }\n    });\n\n    return promise;\n  }\n\n  // Handle messages from the parent window\n  private handleResponse(response: MessageResponse) {\n    if (!this.requestCallbacks[response.id]) {\n      this.logger?.warn(`No callback found for request id: ${response.id}`);\n      return;\n    }\n\n    this.requestCallbacks[response.id].resolve(response.responseData);\n    delete this.requestCallbacks[response.id];\n  }\n\n  setup({\n    logger,\n    endpoint,\n    isElementSelectable,\n    cssSelectorAllowlist,\n    actionClickAllowlist,\n  }: {\n    logger?: ILogger;\n    endpoint?: string;\n    isElementSelectable?: (action: InitializeVisualTaggingSelectorData['actionType'], element: Element) => boolean;\n    cssSelectorAllowlist?: string[];\n    actionClickAllowlist?: string[];\n  } = {}) {\n    this.logger = logger;\n    // If endpoint is customized, don't override it.\n    if (endpoint && this.endpoint === AMPLITUDE_ORIGIN) {\n      this.endpoint = endpoint;\n    }\n    let amplitudeVisualTaggingSelectorInstance: any = null;\n\n    // Attach Event Listener to listen for messages from the parent window\n    window.addEventListener('message', (event) => {\n      this.logger?.debug?.('Message received: ', JSON.stringify(event));\n\n      // Only accept messages from the specified origin\n      if (this.endpoint !== event.origin) {\n        return;\n      }\n\n      const eventData = event?.data as Message<Action> | MessageResponse;\n      const action = eventData?.action;\n\n      // Ignore messages without action\n      if (!action) {\n        return;\n      }\n\n      // If id exists, handle responses to previous requests\n      if ('id' in eventData) {\n        this.logger?.debug?.('Received Response to previous request: ', JSON.stringify(event));\n        this.handleResponse(eventData);\n\n        // If action exists, handle the action using existing handlers\n      } else {\n        if (action === 'ping') {\n          this.notify({ action: 'pong' });\n        } else if (action === 'initialize-visual-tagging-selector') {\n          const actionData = eventData?.data as InitializeVisualTaggingSelectorData;\n          asyncLoadScript(AMPLITUDE_VISUAL_TAGGING_SELECTOR_SCRIPT_URL)\n            .then(() => {\n              // eslint-disable-next-line\n              amplitudeVisualTaggingSelectorInstance = (window as any)?.amplitudeVisualTaggingSelector?.({\n                getEventTagProps,\n                isElementSelectable: (element: Element) => {\n                  if (isElementSelectable) {\n                    return isElementSelectable(actionData?.actionType || 'click', element);\n                  }\n                  return true;\n                },\n                onTrack: this.onTrack,\n                onSelect: this.onSelect,\n                visualHighlightClass: AMPLITUDE_VISUAL_TAGGING_HIGHLIGHT_CLASS,\n                messenger: this,\n                cssSelectorAllowlist,\n                actionClickAllowlist,\n              });\n              this.notify({ action: 'selector-loaded' });\n            })\n            .catch(() => {\n              this.logger?.warn('Failed to initialize visual tagging selector');\n            });\n        } else if (action === 'close-visual-tagging-selector') {\n          // eslint-disable-next-line\n          amplitudeVisualTaggingSelectorInstance?.close?.();\n        }\n      }\n    });\n\n    // Notify the parent window that the page has loaded\n    this.notify({ action: 'page-loaded' });\n  }\n\n  private onSelect = (data: ElementSelectedData) => {\n    this.notify({ action: 'element-selected', data });\n  };\n\n  private onTrack = (type: string, properties: { [key: string]: string | null }) => {\n    if (type === 'selector-mode-changed') {\n      this.notify({ action: 'track-selector-mode-changed', data: properties });\n    } else if (type === 'selector-moved') {\n      this.notify({ action: 'track-selector-moved', data: properties });\n    }\n  };\n}\n"]}