!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).amplitude={})}(this,(function(e){"use strict";var t,n,i=function(){return i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},i.apply(this,arguments)};function o(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{c(i.next(e))}catch(e){r(e)}}function l(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}c((i=i.apply(e,t||[])).next())}))}function r(e,t){var n,i,o,r,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return r={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function l(l){return function(c){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;r&&(r=0,l[0]&&(s=0)),s;)try{if(n=1,i&&(o=2&l[0]?i.return:l[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,l[1])).done)return o;switch(i=0,o&&(l=[2&l[0],o.value]),l[0]){case 0:case 1:o=l;break;case 4:return s.label++,{value:l[1],done:!1};case 5:s.label++,i=l[1],l=[0];continue;case 7:l=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==l[0]&&2!==l[0])){s=0;continue}if(3===l[0]&&(!o||l[1]>o[0]&&l[1]<o[3])){s.label=l[1];break}if(6===l[0]&&s.label<o[1]){s.label=o[1],o=l;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(l);break}o[2]&&s.ops.pop(),s.trys.pop();continue}l=t.call(e,s)}catch(e){l=[6,e],i=0}finally{n=o=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,c])}}}!function(e){e.US="US",e.EU="EU",e.STAGING="STAGING"}(t||(t={})),function(e){e.Unknown="unknown",e.Skipped="skipped",e.Success="success",e.RateLimit="rate_limit",e.PayloadTooLarge="payload_too_large",e.Invalid="invalid",e.Failed="failed",e.Timeout="Timeout",e.SystemError="SystemError"}(n||(n={}));var s=function(){function e(){}return e.prototype.send=function(e,t){return Promise.resolve(null)},e.prototype.buildResponse=function(e){var t,i,o,r,s,l,c,u,a,d,f,h,v,p,y,m,g,b,_,w,S,T;if("object"!=typeof e)return null;var C=e.code||0,R=this.buildStatus(C);switch(R){case n.Success:return{status:R,statusCode:C,body:{eventsIngested:null!==(t=e.events_ingested)&&void 0!==t?t:0,payloadSizeBytes:null!==(i=e.payload_size_bytes)&&void 0!==i?i:0,serverUploadTime:null!==(o=e.server_upload_time)&&void 0!==o?o:0}};case n.Invalid:return{status:R,statusCode:C,body:{error:null!==(r=e.error)&&void 0!==r?r:"",missingField:null!==(s=e.missing_field)&&void 0!==s?s:"",eventsWithInvalidFields:null!==(l=e.events_with_invalid_fields)&&void 0!==l?l:{},eventsWithMissingFields:null!==(c=e.events_with_missing_fields)&&void 0!==c?c:{},eventsWithInvalidIdLengths:null!==(u=e.events_with_invalid_id_lengths)&&void 0!==u?u:{},epsThreshold:null!==(a=e.eps_threshold)&&void 0!==a?a:0,exceededDailyQuotaDevices:null!==(d=e.exceeded_daily_quota_devices)&&void 0!==d?d:{},silencedDevices:null!==(f=e.silenced_devices)&&void 0!==f?f:[],silencedEvents:null!==(h=e.silenced_events)&&void 0!==h?h:[],throttledDevices:null!==(v=e.throttled_devices)&&void 0!==v?v:{},throttledEvents:null!==(p=e.throttled_events)&&void 0!==p?p:[]}};case n.PayloadTooLarge:return{status:R,statusCode:C,body:{error:null!==(y=e.error)&&void 0!==y?y:""}};case n.RateLimit:return{status:R,statusCode:C,body:{error:null!==(m=e.error)&&void 0!==m?m:"",epsThreshold:null!==(g=e.eps_threshold)&&void 0!==g?g:0,throttledDevices:null!==(b=e.throttled_devices)&&void 0!==b?b:{},throttledUsers:null!==(_=e.throttled_users)&&void 0!==_?_:{},exceededDailyQuotaDevices:null!==(w=e.exceeded_daily_quota_devices)&&void 0!==w?w:{},exceededDailyQuotaUsers:null!==(S=e.exceeded_daily_quota_users)&&void 0!==S?S:{},throttledEvents:null!==(T=e.throttled_events)&&void 0!==T?T:[]}};case n.Timeout:default:return{status:R,statusCode:C}}},e.prototype.buildStatus=function(e){return e>=200&&e<300?n.Success:429===e?n.RateLimit:413===e?n.PayloadTooLarge:408===e?n.Timeout:e>=400&&e<500?n.Invalid:e>=500?n.Failed:n.Unknown},e}(),l="Remote config fetch rejected due to timeout after 5 seconds",c="Unexpected error occurred",u=function(){function e(e){var t=e.localConfig,u=e.configKeys,a=this;this.retryTimeout=1e3,this.attempts=0,this.sessionTargetingMatch=!1,this.metrics={},this.getRemoteConfig=function(e,t,n){return o(a,void 0,void 0,(function(){var i,o,s;return r(this,(function(r){switch(r.label){case 0:return i=Date.now(),[4,this.fetchWithTimeout(n)];case 1:return(o=r.sent())&&(s=o.configs&&o.configs[e])?(this.metrics.fetchTimeAPISuccess=Date.now()-i,[2,s[t]]):(this.metrics.fetchTimeAPIFail=Date.now()-i,[2,void 0])}}))}))},this.fetchWithTimeout=function(e){return o(a,void 0,void 0,(function(){var t,n,i;return r(this,(function(o){switch(o.label){case 0:return t=new AbortController,n=setTimeout((function(){return t.abort()}),5e3),[4,this.fetchRemoteConfig(t.signal,e)];case 1:return i=o.sent(),clearTimeout(n),[2,i]}}))}))},this.fetchRemoteConfig=function(e,t){return o(a,void 0,void 0,(function(){var o,u,a,d,f,h,v,p,y,m,g,b;return r(this,(function(r){switch(r.label){case 0:if(t===this.lastFetchedSessionId&&this.attempts>=this.localConfig.flushMaxRetries)return[2,this.completeRequest({err:"Remote config fetch rejected due to exceeded retry count"})];if(e.aborted)return[2,this.completeRequest({err:l})];t!==this.lastFetchedSessionId&&(this.lastFetchedSessionId=t,this.attempts=0),r.label=1;case 1:r.trys.push([1,3,,4]),o=new URLSearchParams({api_key:this.localConfig.apiKey});try{for(u=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(this.configKeys),a=u.next();!a.done;a=u.next())d=a.value,o.append("config_keys",d)}catch(e){m={error:e}}finally{try{a&&!a.done&&(g=u.return)&&g.call(u)}finally{if(m)throw m.error}}return t&&o.set("session_id",String(t)),f={headers:{Accept:"*/*"},method:"GET"},h="".concat(this.getServerUrl(),"?").concat(o.toString()),this.attempts+=1,[4,fetch(h,i(i({},f),{signal:e}))];case 2:if(null===(v=r.sent()))return[2,this.completeRequest({err:c})];switch((new s).buildStatus(v.status)){case n.Success:return this.attempts=0,[2,this.parseAndStoreConfig(v)];case n.Failed:return[2,this.retryFetch(e,t)];default:return[2,this.completeRequest({err:"Network error occurred, remote config fetch failed"})]}case 3:return p=r.sent(),y=p,e.aborted?[2,this.completeRequest({err:l})]:[2,this.completeRequest({err:null!==(b=y.message)&&void 0!==b?b:c})];case 4:return[2]}}))}))},this.retryFetch=function(e,t){return o(a,void 0,void 0,(function(){var n=this;return r(this,(function(i){switch(i.label){case 0:return[4,new Promise((function(e){return setTimeout(e,n.attempts*n.retryTimeout)}))];case 1:return i.sent(),[2,this.fetchRemoteConfig(e,t)]}}))}))},this.parseAndStoreConfig=function(e){return o(a,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return[4,e.json()];case 1:return t=n.sent(),this.completeRequest({success:"Remote config successfully fetched"}),[2,t]}}))}))},this.localConfig=t,this.configKeys=u}return e.prototype.getServerUrl=function(){return this.localConfig.serverZone===t.STAGING?"https://sr-client-cfg.stag2.amplitude.com/config":this.localConfig.serverZone===t.EU?"https://sr-client-cfg.eu.amplitude.com/config":"https://sr-client-cfg.amplitude.com/config"},e.prototype.completeRequest=function(e){var t=e.err,n=e.success;if(t)throw new Error(t);n&&this.localConfig.loggerProvider.log(n)},e}(),a=function(e){var t=e.localConfig,n=e.configKeys;return o(void 0,void 0,void 0,(function(){return r(this,(function(e){return[2,new u({localConfig:t,configKeys:n})]}))}))};e.createRemoteConfigFetch=a,Object.defineProperty(e,"__esModule",{value:!0})}));
