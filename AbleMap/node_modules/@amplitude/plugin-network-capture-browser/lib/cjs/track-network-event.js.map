{"version":3,"file":"track-network-event.js","sourceRoot":"","sources":["../../src/track-network-event.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  BrowserClient,\n  NetworkRequestEvent,\n  NetworkCaptureRule,\n  NetworkTrackingOptions,\n  getGlobalScope,\n} from '@amplitude/analytics-core';\nimport { filter } from 'rxjs';\nimport { AllWindowObservables, TimestampedEvent } from './network-capture-plugin';\nimport { AMPLITUDE_NETWORK_REQUEST_EVENT } from './constants';\n\nconst DEFAULT_STATUS_CODE_RANGE = '500-599';\n\nfunction wildcardMatch(str: string, pattern: string) {\n  // Escape all regex special characters except for *\n  const escapedPattern = pattern.replace(/[-[\\]{}()+?.,\\\\^$|#\\s]/g, '\\\\$&');\n  // Replace * with .*\n  const regexPattern = '^' + escapedPattern.replace(/\\*/g, '.*') + '$';\n  const regex = new RegExp(regexPattern);\n  return regex.test(str);\n}\n\nfunction isStatusCodeInRange(statusCode: number, range: string) {\n  const ranges = range.split(',');\n  for (const r of ranges) {\n    const [start, end] = r.split('-').map(Number);\n    if (statusCode === start && end === undefined) {\n      return true;\n    }\n    if (statusCode >= start && statusCode <= end) {\n      return true;\n    }\n  }\n  return false;\n}\n\nfunction isCaptureRuleMatch(rule: NetworkCaptureRule, hostname: string, status?: number) {\n  // check if the host is in the allowed hosts\n  if (rule.hosts && !rule.hosts.find((host: string) => wildcardMatch(hostname, host))) {\n    return;\n  }\n\n  // check if the status code is in the allowed range\n  if (status || status === 0) {\n    const statusCodeRange = rule.statusCodeRange || DEFAULT_STATUS_CODE_RANGE;\n    if (!isStatusCodeInRange(status, statusCodeRange)) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\nfunction parseUrl(url: string) {\n  try {\n    /* istanbul ignore next */\n    const currentHref = getGlobalScope()?.location.href;\n    const urlObj = new URL(url, currentHref);\n    const query = urlObj.searchParams.toString();\n    const fragment = urlObj.hash.replace('#', '');\n    const href = urlObj.href;\n    const host = urlObj.host;\n    urlObj.hash = '';\n    urlObj.search = '';\n    const hrefWithoutQueryOrHash = urlObj.href;\n    return { query, fragment, href, hrefWithoutQueryOrHash, host };\n  } catch (e) {\n    /* istanbul ignore next */\n    return;\n  }\n}\n\nexport function shouldTrackNetworkEvent(networkEvent: NetworkRequestEvent, options: NetworkTrackingOptions = {}) {\n  const urlObj = parseUrl(networkEvent.url);\n  /* istanbul ignore if */\n  if (!urlObj) {\n    // if the URL failed to parse, do not track the event\n    // this is a probably impossible case that would only happen if the URL is malformed\n    /* istanbul ignore next */\n    return false;\n  }\n  const { host } = urlObj;\n\n  // false if is amplitude request and not configured to track amplitude requests\n  if (\n    options.ignoreAmplitudeRequests !== false &&\n    (wildcardMatch(host, '*.amplitude.com') || wildcardMatch(host, 'amplitude.com'))\n  ) {\n    return false;\n  }\n\n  // false if the host is in the ignore list\n  if (options.ignoreHosts?.find((ignoreHost: string) => wildcardMatch(host, ignoreHost))) {\n    return false;\n  }\n\n  // false if the status code is not 500-599 and there are no captureRules\n  if (\n    !options.captureRules &&\n    networkEvent.status !== undefined &&\n    !isStatusCodeInRange(networkEvent.status, DEFAULT_STATUS_CODE_RANGE)\n  ) {\n    return false;\n  }\n\n  if (options.captureRules) {\n    // find the first capture rule, in reverse-order,\n    // that is a match (true) or a miss (false)\n    let isMatch: boolean | undefined;\n    [...options.captureRules].reverse().find((rule) => {\n      isMatch = isCaptureRuleMatch(rule, host, networkEvent.status);\n      return isMatch !== undefined;\n    });\n\n    // if we found a miss (false) or no match (undefined),\n    // then do not track the event\n    if (!isMatch) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\nexport type NetworkAnalyticsEvent = {\n  ['[Amplitude] URL']: string;\n  ['[Amplitude] URL Query']?: string;\n  ['[Amplitude] URL Fragment']?: string;\n  ['[Amplitude] Request Method']: string;\n  ['[Amplitude] Status Code']?: number;\n  ['[Amplitude] Start Time']?: number; // unix timestamp\n  ['[Amplitude] Completion Time']?: number; // unix timestamp\n  ['[Amplitude] Duration']?: number; // completionTime - startTime (millis)\n  ['[Amplitude] Request Body Size']?: number;\n  ['[Amplitude] Response Body Size']?: number;\n};\n\nexport function trackNetworkEvents({\n  allObservables,\n  networkTrackingOptions,\n  amplitude,\n}: {\n  allObservables: AllWindowObservables;\n  networkTrackingOptions: NetworkTrackingOptions;\n  amplitude: BrowserClient;\n}) {\n  const { networkObservable } = allObservables;\n\n  const filteredNetworkObservable = networkObservable.pipe(\n    filter((event: TimestampedEvent<NetworkRequestEvent>) => {\n      // Only track network events that should be tracked,\n      return shouldTrackNetworkEvent(event.event as NetworkRequestEvent, networkTrackingOptions);\n    }),\n  );\n\n  return filteredNetworkObservable.subscribe((networkEvent) => {\n    const request = networkEvent.event as NetworkRequestEvent;\n\n    // convert to NetworkAnalyticsEvent\n    const urlObj = parseUrl(request.url);\n    /* istanbul ignore if */\n    if (!urlObj) {\n      // if the URL failed to parse, do not track the event\n      // this is a very unlikely case, because URL() shouldn't throw an exception\n      // when the URL is a valid URL\n      /* istanbul ignore next */\n      return;\n    }\n\n    const networkAnalyticsEvent: NetworkAnalyticsEvent = {\n      ['[Amplitude] URL']: urlObj.hrefWithoutQueryOrHash,\n      ['[Amplitude] URL Query']: urlObj.query,\n      ['[Amplitude] URL Fragment']: urlObj.fragment,\n      ['[Amplitude] Request Method']: request.method,\n      ['[Amplitude] Status Code']: request.status,\n      ['[Amplitude] Start Time']: request.startTime,\n      ['[Amplitude] Completion Time']: request.endTime,\n      ['[Amplitude] Duration']: request.duration,\n      ['[Amplitude] Request Body Size']: request.requestBodySize,\n      ['[Amplitude] Response Body Size']: request.responseBodySize,\n    };\n\n    /* istanbul ignore next */\n    amplitude?.track(AMPLITUDE_NETWORK_REQUEST_EVENT, networkAnalyticsEvent);\n  });\n}\n"]}